<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Libre Baskerville','Times New Roman',serif;
  font-size:13px;
}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #999;padding:6px}
th{text-align:center;background:#f0f0f0}
td.number{text-align:right}
tr.nodata{background:#f8ebf7}
tbody tr:hover{background:#defaf9}
.controls{margin-bottom:10px;display:flex;gap:10px;align-items:center}
a{color:inherit;text-decoration:none}
</style>
</head>
<body>

<div class="controls">
  <select id="source"></select>
  <select id="year">
    <option>2023</option>
    <option>2024</option>
    <option>2025</option>
    <option selected>2026</option>
  </select>
  <button onclick="load()">L·∫•y d·ªØ li·ªáu</button>
  <input id="search" placeholder="T√¨m ki·∫øm..." onkeyup="filter()">
</div>

<h2 id="title">ƒêang load d·ªØ li·ªáu...</h2>

<table>
<thead id="thead"></thead>
<tbody id="tb">
<tr><td colspan="9" align="center">ƒêang load d·ªØ li·ªáu ...</td></tr>
</tbody>
</table>

<script>
/* =======================
   CONFIG CSV
======================= */
const CSV_MAP = {
  dvft: {
    label: 'ƒê·∫ßu v√†o Finn',
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1180743955&single=true&output=csv',
    group: 'DV'
  },
  dvfm: {
    label: 'ƒê·∫ßu v√†o Finn X∆∞·ªüng',
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1178854260&single=true&output=csv',
    group: 'DV'
  },
  drft: {
    label: 'ƒê·∫ßu ra Finn',
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=147272766&single=true&output=csv',
    group: 'DR'
  },
  drfm: {
    label: 'ƒê·∫ßu ra Finn X∆∞·ªüng',
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1704976963&single=true&output=csv',
    group: 'DR'
  }
};

/* =======================
   COLUMN MAP (GI·ªÆ NGUY√äN)
======================= */
const COL_DV = { X:23,E:4,G:6,M:12,P:15,V:21,S:18,T:19,AA:26,AB:27,AD:29 };
const COL_DR = { V:21,E:4,G:6,M:12,P:15,S:18,T:19,AD:29,X:23,Y:24 };

let origin=[];

/* =======================
   INIT SOURCE SELECT
======================= */
const source=document.getElementById('source');
Object.entries(CSV_MAP).forEach(([k,v])=>{
  source.innerHTML+=`<option value="${k}">${v.label}</option>`;
});

/* =======================
   CSV PARSER (GI·ªÆ NGUY√äN)
======================= */
function parseCSV(t){
  const r=[];let c='',row=[],q=false;
  for(let i=0;i<t.length;i++){
    const ch=t[i],n=t[i+1];
    if(ch=='"'&&n=='"'){c+='"';i++}
    else if(ch=='"')q=!q
    else if(ch==','&&!q){row.push(c);c=''}
    else if((ch=='\n'||ch=='\r')&&!q){
      if(c||row.length){row.push(c);r.push(row)}
      row=[];c=''
    }else c+=ch
  }
  if(c||row.length){row.push(c);r.push(row)}
  return r
}

/* =======================
   YEAR + NUMBER FIX
======================= */
function getYear(v){
  const m=v?.match(/(19|20)\d{2}/);
  return m?m[0]:null;
}

/* üîß S·ª¨A DUY NH·∫§T CHO DR */
function parseNumber(val){
  if(!val) return 0;
  let v=val.toString().trim();
  if(v.includes('.')&&!v.includes(',')) v=v.replace(/\./g,'');
  if(v.includes(',')&&v.includes('.')){
    if(v.lastIndexOf(',')>v.lastIndexOf('.')){
      v=v.replace(/\./g,'').replace(',','.');
    }else{
      v=v.replace(/,/g,'');
    }
  }
  const n=Number(v);
  return isNaN(n)?0:n;
}

/* =======================
   HEADER
======================= */
const TABLE_HEADER={
  DV:['MST-KH-S·ªë Hƒê','Ng√†y','T√™n KH','T·ªïng ti·ªÅn','Tr·∫°ng th√°i','V','Web','ID','Xem'],
  DR:['V','Ng√†y','T√™n KH','T·ªïng ti·ªÅn','Tr·∫°ng th√°i','Web','ID','AD','Xem']
};

function renderHeader(group){
  thead.innerHTML='';
  const tr=document.createElement('tr');
  TABLE_HEADER[group].forEach(t=>{
    const th=document.createElement('th');
    th.textContent=t;
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}

/* =======================
   LOAD DATA
======================= */
const year=document.getElementById('year');
const title=document.getElementById('title');
const tb=document.getElementById('tb');
const search=document.getElementById('search');
const thead=document.getElementById('thead');

function load(){
  const key=source.value;
  const y=year.value;
  const cfg=CSV_MAP[key];

  title.textContent=`${cfg.label} nƒÉm ${y}`;
  renderHeader(cfg.group);
  tb.innerHTML='<tr><td colspan="9">ƒêang load d·ªØ li·ªáu ...</td></tr>';

  fetch(cfg.url).then(r=>r.text()).then(t=>{
    const rows=parseCSV(t);
    origin=[];
    for(let i=4;i<rows.length;i++){
      const r=rows[i];
      const d=r[cfg.group==='DV'?COL_DV.E:COL_DR.E];
      if(!d||getYear(d)!==y) continue;

      if(cfg.group==='DV'){
        origin.push({
          X:r[COL_DV.X],
          E:d,
          G:r[COL_DV.G],
          M:parseNumber(r[COL_DV.M]),
          P:r[COL_DV.P],
          V:r[COL_DV.V],
          S:r[COL_DV.S],
          S_link:r[COL_DV.AA],
          T:r[COL_DV.T],
          XEM:r[COL_DV.AB],
          AD:r[COL_DV.AD]
        });
      }else{
        origin.push({
          X:r[COL_DR.V],
          E:d,
          G:r[COL_DR.G],
          M:parseNumber(r[COL_DR.M]),   // üîß FIX DR
          P:r[COL_DR.P],
          S:r[COL_DR.S],
          S_link:r[COL_DR.X],
          T:r[COL_DR.T],
          AD:r[COL_DR.AD],
          XEM:r[COL_DR.Y]
        });
      }
    }
    render(origin);
  });
}

/* =======================
   RENDER
======================= */
function render(data){
  tb.innerHTML='';
  if(!data.length){
    tb.innerHTML='<tr><td colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    return;
  }
  data.forEach(r=>{
    const tr=document.createElement('tr');

    if(  !r.AD ||  r.AD.toString().toLowerCase() === 'nodata'){  tr.className = 'nodata';}

    const tText=(r.T&&r.T.length>20)?r.T.slice(0,18)+'***':r.T;

    tr.innerHTML=`
<td>${r.X||''}</td>
<td>${r.E||''}</td>
<td>${r.G||''}</td>
<td class="number">${r.M.toLocaleString('en-US')}</td>
<td>${r.P||''}</td>
<td>${r.V||''}</td>
<td>${r.S_link?`<a href="${r.S_link}" target="_blank">${r.S}</a>`:(r.S||'')}</td>
<td>${tText||''}</td>
<td>${r.XEM?`<a href="${r.XEM}" target="_blank">xem</a>`:''}</td>
`;
    tb.appendChild(tr);
  });
}

/* =======================
   FILTER
======================= */
function filter(){
  const k=search.value.toLowerCase();
  render(origin.filter(r=>Object.values(r).some(v=>v&&v.toString().toLowerCase().includes(k))));
}

window.onload=load;
</script>
</body>
</html>

