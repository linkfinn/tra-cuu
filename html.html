<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">

<!-- ===== GOOGLE FONT ===== -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Libre Baskerville','Times New Roman',serif;
  font-size:13px;
}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #999;padding:6px}
th{text-align:center;background:#f0f0f0}
td.number{text-align:right}
tr.nodata{background:#f8ebf7}
tbody tr:hover{background:#defaf9}
.controls{margin-bottom:12px;display:flex;gap:10px;align-items:center}
</style>
</head>

<body>

<div class="controls">
  <select id="source"></select>
  <select id="year">
    <option>2023</option>
    <option>2024</option>
    <option>2025</option>
    <option selected>2026</option>
  </select>
  <button onclick="load()">Lấy dữ liệu</button>
  <input id="search" placeholder="Tìm kiếm..." onkeyup="filter()">
</div>

<h2 id="title">Đang load...</h2>

<table>
<thead id="thead"></thead>
<tbody id="tb">
<tr><td colspan="9" align="center">Đang load...</td></tr>
</tbody>
</table>

<script>
/* =======================
   DOM
======================= */
const source = document.getElementById('source');
const year = document.getElementById('year');
const title = document.getElementById('title');
const tb = document.getElementById('tb');
const search = document.getElementById('search');
const thead = document.getElementById('thead');

/* =======================
   CSV CONFIG
======================= */
const CSV_MAP = {
  dvft:{
    label:'Đầu vào Finn',
    group:'DV',
    url:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1180743955&single=true&output=csv'
  },
  dvfm:{
    label:'Đầu vào Finn Xưởng',
    group:'DV',
    url:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1178854260&single=true&output=csv'
  },
  drft:{
    label:'Đầu ra Finn',
    group:'DR',
    url:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=147272766&single=true&output=csv'
  },
  drfm:{
    label:'Đầu ra Finn Xưởng',
    group:'DR',
    url:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcra_L88XF16TMRuyqoZwFWvQkjzAwI4BhLNWSBA4fcHhKQzpnvoKdIyflfnCh25uWZzrfRhMvkyIc/pub?gid=1704976963&single=true&output=csv'
  }
};

/* =======================
   COLUMN MAP
======================= */
const COL_DV={X:23,E:4,G:6,M:12,P:15,V:21,S:18,T:19,AA:26,AB:27,AD:29};
const COL_DR={V:21,E:4,G:6,M:12,P:15,S:18,T:19,AD:29,X:23,Y:24};

/* =======================
   TABLE HEADER
======================= */
const TABLE_HEADER={
  DV:['MST-KH-Số HĐ','Ngày chứng từ','Tên khách hàng','Tổng tiền','Trạng thái','V','Web tra cứu','ID/Fkey','Xem'],
  DR:['V','Ngày chứng từ','Tên khách hàng','Tổng tiền','Trạng thái','Tra cứu','ID/Fkey','AD','Xem']
};

/* =======================
   INIT SOURCE SELECT
======================= */
Object.entries(CSV_MAP).forEach(([k,v])=>{
  source.innerHTML+=`<option value="${k}">${v.label}</option>`;
});

/* =======================
   HELPERS
======================= */
function parseCSV(t){
  const r=[];let row=[],c='',q=false;
  for(let i=0;i<t.length;i++){
    const ch=t[i],n=t[i+1];
    if(ch=='"'&&n=='"'){c+='"';i++}
    else if(ch=='"')q=!q
    else if(ch==','&&!q){row.push(c);c=''}
    else if((ch=='\n'||ch=='\r')&&!q){
      if(c||row.length){row.push(c);r.push(row)}
      row=[];c=''
    }else c+=ch
  }
  if(c||row.length){row.push(c);r.push(row)}
  return r
}

function getYear(v){
  const m=v?.match(/(19|20)\d{2}/);
  return m?m[0]:null;
}

function formatDate(v){
  const m=v?.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-]((19|20)\d{2})/);
  return m?`${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/${m[3]}`:v||'';
}

function shortT(v){
  if(!v) return '';
  return v.length>20 ? v.slice(0,18)+'***' : v;
}

function renderHeader(group){
  thead.innerHTML='';
  const tr=document.createElement('tr');
  TABLE_HEADER[group].forEach(h=>{
    const th=document.createElement('th');
    th.textContent=h;
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}

/* =======================
   LOAD DATA
======================= */
let origin=[];

function load(){
  const key=source.value;
  const y=year.value;
  const cfg=CSV_MAP[key];

  title.textContent=`${cfg.label} năm ${y}`;
  tb.innerHTML='<tr><td colspan="9">Đang load...</td></tr>';
  renderHeader(cfg.group);

  fetch(cfg.url).then(r=>r.text()).then(t=>{
    const rows=parseCSV(t);
    origin=[];

    for(let i=4;i<rows.length;i++){
      const r=rows[i];
      const d=r[cfg.group==='DV'?COL_DV.E:COL_DR.E];
      if(!d||getYear(d)!==y)continue;

      if(cfg.group==='DV'){
        origin.push({
          X:r[COL_DV.X],
          E:formatDate(d),
          G:r[COL_DV.G],
          M:r[COL_DV.M],
          P:r[COL_DV.P],
          V:r[COL_DV.V],
          S:r[COL_DV.S],
          S_link:r[COL_DV.AA],
          T:shortT(r[COL_DV.T]),
          XEM:r[COL_DV.AB],
          AD:r[COL_DV.AD]
        });
      }else{
        origin.push({
          V:r[COL_DR.V],
          E:formatDate(d),
          G:r[COL_DR.G],
          M:r[COL_DR.M],
          P:r[COL_DR.P],
          S:r[COL_DR.S],
          S_link:r[COL_DR.X],
          T:shortT(r[COL_DR.T]),
          XEM:r[COL_DR.Y],
          AD:r[COL_DR.AD]
        });
      }
    }
    render(origin,cfg.group);
  });
}

/* =======================
   RENDER
======================= */
function render(data,group){
  tb.innerHTML='';
  if(!data.length){
    tb.innerHTML='<tr><td colspan="9">Không có dữ liệu</td></tr>';
    return;
  }

  data.forEach(r=>{
    const tr=document.createElement('tr');

    if(group==='DV' && r.AD==='NoData') tr.className='nodata';
    if(group==='DR' && !r.AD) tr.className='nodata';

    tr.innerHTML = group==='DV' ? `
      <td>${r.X||''}</td>
      <td>${r.E}</td>
      <td>${r.G||''}</td>
      <td class="number">${(+r.M||0).toLocaleString()}</td>
      <td>${r.P||''}</td>
      <td>${r.V||''}</td>
      <td>${r.S_link?`<a href="${r.S_link}" target="_blank">${r.S}</a>`:r.S}</td>
      <td>${r.T||''}</td>
      <td>${r.XEM?`<a href="${r.XEM}" target="_blank">xem</a>`:''}</td>
    ` : `
      <td>${r.V||''}</td>
      <td>${r.E}</td>
      <td>${r.G||''}</td>
      <td class="number">${(+r.M||0).toLocaleString()}</td>
      <td>${r.P||''}</td>
      <td>${r.S_link?`<a href="${r.S_link}" target="_blank">${r.S}</a>`:r.S}</td>
      <td>${r.T||''}</td>
      <td>${r.AD||''}</td>
      <td>${r.XEM?`<a href="${r.XEM}" target="_blank">xem</a>`:''}</td>
    `;
    tb.appendChild(tr);
  });
}

/* =======================
   SEARCH
======================= */
function filter(){
  const k=search.value.toLowerCase();
  render(origin.filter(r=>Object.values(r).some(v=>v&&v.toString().toLowerCase().includes(k))),
         CSV_MAP[source.value].group);
}

window.onload=load;
</script>
</body>
</html>
